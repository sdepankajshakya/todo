<div class="task-list" [ngStyle]="{background: task.bgColor}" [ngClass]="task.isDark ? 'light-text' : 'dark-text'" cdkDropList [cdkDropListData]="task.subtasks" (cdkDropListDropped)="onSubtaskDrop($event)" [cdkDropListConnectedTo]="connectedDropLists" [id]="'subtasks-list-' + taskIndex">
    <div class="dropzone-overlay" *ngIf="isDragging"></div>
    <!-- List header -->
    <div class="list-header">
        <span class="move-list-handle" cdkDragHandle title="Move list">
            <i class="fas fa-grip-lines"></i>
        </span>
        <div class="wrap-text list-title">
            <span *ngIf="!editingTaskName" (click)="editingTaskName = true" [ngClass]="task.isDark ? 'light-text' : 'dark-text'" class="task-title-text">{{ task.name }}</span>
            <input *ngIf="editingTaskName" class="task-title-input" [(ngModel)]="task.name" (blur)="editingTaskName = false; onTaskNameChange()" (keyup.enter)="editingTaskName = false; onTaskNameChange()" [ngClass]="task.isDark ? 'light-text' : 'dark-text'" autofocus />
        </div>
        <div class="list-menu-wrapper">
            <button mat-icon-button [matMenuTriggerFor]="listMenu" class="list-menu-btn">
                <i class="fas fa-ellipsis-h"></i>
            </button>
            <mat-menu #listMenu="matMenu">
                <button mat-menu-item (click)="openColorPalette(task)">
                    <i class="fas fa-palette" style="margin-right: 10px;"></i>
                    <span>Change color</span>
                </button>
                <button mat-menu-item (click)="onDeleteTask()">
                    <i class="fas fa-trash-alt" style="margin-right: 10px;"></i>
                    <span>Delete list</span>
                </button>
            </mat-menu>
        </div>
    </div>

    <!-- Subtasks list -->
    <div class="subtasks-list">
        <div class="subtask-card card-style" *ngFor="let subtask of task.subtasks; let j = index" cdkDrag (cdkDragStarted)="onDragStarted()" (cdkDragEnded)="onDragEnded()">
            <mat-checkbox class="circular-checkbox" [checked]="subtask.isCompleted" (change)="markAsComplete($event.checked, subtask)"></mat-checkbox>
            <span *ngIf="!editingSubtaskName[j] && !isValidUrl(subtask.name)" (click)="editingSubtaskName[j] = true" [ngClass]="{'task-completed': subtask.isCompleted, 'light-text': task.isDark}" class="subtask-title-text">{{ subtask.name }}</span>
            <span *ngIf="!editingSubtaskName[j] && isValidUrl(subtask.name)" class="subtask-title-text subtask-link-row" [ngClass]="{'task-completed': subtask.isCompleted, 'light-text': task.isDark}">
                <a [href]="subtask.name" target="_blank" rel="noopener" class="subtask-link">{{ subtask.name }}</a>
                <span class="subtask-link-edit-area" (click)="editingSubtaskName[j] = true" title="Edit subtask"></span>
            </span>
            <input *ngIf="editingSubtaskName[j]" class="subtask-title-input" [(ngModel)]="subtask.name" (blur)="editingSubtaskName[j] = false; onTaskNameChange()" (keyup.enter)="editingSubtaskName[j] = false; onTaskNameChange()" [ngClass]="{'task-completed': subtask.isCompleted, 'light-text': task.isDark}" autofocus />
            <i class="fas fa-trash-alt icon-delete" (click)="onDeleteSubtask(subtask)"></i>
        </div>
    </div>

    <!-- Add subtask -->
    <div class="add-card-row">
        <input class="add-card-input" type="text" placeholder="Add a task..." [(ngModel)]="subtaskName" (keyup.enter)="addSubtask()" [ngClass]="task.isDark ? 'light-text' : 'dark-text'" aria-label="Add a task" />
        <button class="add-card-btn" (click)="addSubtask()" aria-label="Add task">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>